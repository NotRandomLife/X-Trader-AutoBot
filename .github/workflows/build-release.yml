name: Build & Release (Nuitka OneDir)

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          architecture: "x64"

      - name: Install deps (pin setuptools)
        working-directory: X_Trader_AutoBot
        shell: pwsh
        run: |
          python -m pip install --upgrade pip wheel
          pip install "setuptools==81.0.0"
          pip install -r requirements.txt
          pip install "nuitka==2.8" pillow

      - name: Nuitka cache dir
        shell: pwsh
        run: |
          $p = Join-Path $env:RUNNER_TEMP "nuitka_cache"
          New-Item -ItemType Directory -Force -Path $p | Out-Null
          "NUITKA_CACHE_DIR=$p" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Make icon (.ico)
        working-directory: X_Trader_AutoBot
        shell: pwsh
        run: |
          python -c "from PIL import Image; img=Image.open('assets/xtrader_icon.png').convert('RGBA'); img.save('assets/xtrader.ico', sizes=[(256,256),(128,128),(64,64),(48,48),(32,32),(16,16)])"

      - name: Build (Windows OneDir)
        working-directory: X_Trader_AutoBot
        shell: pwsh
        run: |
          python -m nuitka `
            app.pyw `
            --mode=app-dist `
            --enable-plugin=tk-inter `
            --include-data-dir=assets=assets `
            --assume-yes-for-downloads `
            --output-dir=build `
            --windows-console-mode=disable `
            --windows-icon-from-ico=assets\xtrader.ico

      - name: Zip
        shell: pwsh
        working-directory: X_Trader_AutoBot
        run: |
          $dist = Get-ChildItem -Directory build\*.dist | Select-Object -First 1
          if (-not $dist) { throw "No .dist found" }
          New-Item -ItemType Directory -Force -Path ..\artifacts | Out-Null
          Compress-Archive -Path $dist.FullName -DestinationPath ..\artifacts\X-Trader_AutoBot-windows.zip -Force

      - uses: actions/upload-artifact@v4
        with:
          name: windows
          path: artifacts/X-Trader_AutoBot-windows.zip

  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: System deps (Tk)
        run: |
          sudo apt-get update
          sudo apt-get install -y tk-dev tcl-dev zip

      - name: Install deps (pin setuptools)
        working-directory: X_Trader_AutoBot
        run: |
          python -m pip install --upgrade pip wheel
          pip install "setuptools==81.0.0"
          pip install -r requirements.txt
          pip install "nuitka==2.8"

      - name: Nuitka cache dir
        run: |
          mkdir -p "$RUNNER_TEMP/nuitka_cache"
          echo "NUITKA_CACHE_DIR=$RUNNER_TEMP/nuitka_cache" >> "$GITHUB_ENV"

      - name: Build (Linux OneDir)
        working-directory: X_Trader_AutoBot
        run: |
          python -m nuitka             app.pyw             --mode=app-dist             --enable-plugin=tk-inter             --include-data-dir=assets=assets             --assume-yes-for-downloads             --output-dir=build

      - name: Zip
        working-directory: X_Trader_AutoBot
        run: |
          DIST="$(ls -d build/*.dist | head -n 1 || true)"
          if [ -z "$DIST" ]; then echo "No .dist found"; exit 1; fi
          mkdir -p ../artifacts
          (cd build && zip -r "../../artifacts/X-Trader_AutoBot-linux.zip" "$(basename "$DIST")")

      - uses: actions/upload-artifact@v4
        with:
          name: linux
          path: artifacts/X-Trader_AutoBot-linux.zip

  macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          architecture: "arm64"

      - name: Install Tcl/Tk + verify paths
        shell: bash
        working-directory: X_Trader_AutoBot
        run: |
          set -e
          brew update
          brew install tcl-tk
          TCLTK_PREFIX="$(brew --prefix tcl-tk)"
          echo "TCLTK_PREFIX=$TCLTK_PREFIX" >> "$GITHUB_ENV"
          echo "TCL_LIBRARY=$TCLTK_PREFIX/lib/tcl8.6" >> "$GITHUB_ENV"
          echo "TK_LIBRARY=$TCLTK_PREFIX/lib/tk8.6" >> "$GITHUB_ENV"
          echo "DYLD_FALLBACK_LIBRARY_PATH=$TCLTK_PREFIX/lib:/usr/local/lib:/usr/lib" >> "$GITHUB_ENV"

          echo "TCLTK_PREFIX=$TCLTK_PREFIX"
          ls -la "$TCLTK_PREFIX/lib" | head -n 200
          test -d "$TCLTK_PREFIX/lib/tcl8.6"
          test -d "$TCLTK_PREFIX/lib/tk8.6"

          python -c "import tkinter; print('tkinter OK, TkVersion=', tkinter.TkVersion)"

          ICON_PNG="assets/xtrader_icon.png"
          ICONSET_DIR="$RUNNER_TEMP/xtrader.iconset"
          ICNS_OUT="assets/xtrader.icns"
          rm -rf "$ICONSET_DIR"
          mkdir -p "$ICONSET_DIR"
          for size in 16 32 64 128 256 512; do
            sips -z $size $size "$ICON_PNG" --out "$ICONSET_DIR/icon_${size}x${size}.png" >/dev/null
          done
          sips -z 1024 1024 "$ICON_PNG" --out "$ICONSET_DIR/icon_512x512@2x.png" >/dev/null
          iconutil -c icns "$ICONSET_DIR" -o "$ICNS_OUT"
          test -f "$ICNS_OUT"

      - name: Install deps (pin setuptools)
        working-directory: X_Trader_AutoBot
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip wheel
          pip install "setuptools==81.0.0"
          pip install -r requirements.txt
          pip install "nuitka==2.8"

      - name: Nuitka cache dir
        shell: bash
        run: |
          set -e
          mkdir -p "$RUNNER_TEMP/nuitka_cache"
          echo "NUITKA_CACHE_DIR=$RUNNER_TEMP/nuitka_cache" >> "$GITHUB_ENV"

      - name: Build (macOS .app) - explicit Tcl/Tk dirs
        working-directory: X_Trader_AutoBot
        shell: bash
        run: |
          set -e
          : "${TCLTK_PREFIX:?TCLTK_PREFIX not set}"
          python -m nuitka             app.pyw             --mode=app-dist             --enable-plugin=tk-inter             --tcl-library-dir="$TCLTK_PREFIX/lib/tcl8.6"             --tk-library-dir="$TCLTK_PREFIX/lib/tk8.6"             --include-data-dir=assets=assets             --assume-yes-for-downloads             --output-dir=build             --macos-app-icon=assets/xtrader.icns

      - name: Zip
        working-directory: X_Trader_AutoBot
        shell: bash
        run: |
          set -e
          APP="$(ls -d build/*.app | head -n 1 || true)"
          if [ -z "$APP" ]; then echo "No .app found"; exit 1; fi
          mkdir -p ../artifacts
          ditto -c -k --keepParent "$APP" "../artifacts/X-Trader_AutoBot-macos.zip"

      - uses: actions/upload-artifact@v4
        with:
          name: macos
          path: artifacts/X-Trader_AutoBot-macos.zip

  release:
    runs-on: ubuntu-latest
    needs: [windows, linux, macos]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: release

      - name: Collect zips
        shell: bash
        run: |
          set -e
          mkdir -p out
          find release -type f -name "*.zip" -maxdepth 3 -print -exec cp -f {} out/ \;
          ls -la out

      - uses: softprops/action-gh-release@v2
        with:
          files: out/*.zip
