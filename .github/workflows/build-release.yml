name: Build & Release (Nuitka app-dist)

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ windows-latest, ubuntu-latest, macos-latest ]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Windows + Linux: setup-python 3.10 x64
      - name: Setup Python 3.10 (Windows/Linux)
        if: runner.os != 'macOS'
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          architecture: "x64"
          cache: "pip"
          cache-dependency-path: |
            X_Trader_AutoBot/requirements.txt

      # macOS: setup-python 3.10 ARM64 (evita python x64 su runner ARM -> libintl crash)
      - name: Setup Python 3.10 (macOS ARM64)
        if: runner.os == 'macOS'
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          architecture: "arm64"
          cache: "pip"
          cache-dependency-path: |
            X_Trader_AutoBot/requirements.txt

      - name: Compute Version (for Windows metadata)
        id: ver
        shell: bash
        run: |
          set -e
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
            SEM="${TAG#v}"
          else
            SEM="0.0.0"
          fi
          IFS='.' read -r A B C <<<"$SEM"
          A="${A:-0}"; B="${B:-0}"; C="${C:-0}"
          WIN_VER="$A.$B.$C.0"
          echo "win=$WIN_VER" >> "$GITHUB_OUTPUT"

      - name: Linux deps (Tk)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y tk-dev tcl-dev

      # macOS: install Tcl/Tk and generate ICNS icon (no imageio needed)
      - name: macOS deps (Tcl/Tk + icon)
        if: runner.os == 'macOS'
        shell: bash
        working-directory: X_Trader_AutoBot
        run: |
          set -e
          brew update
          brew install tcl-tk

          TCLTK_PREFIX="$(brew --prefix tcl-tk)"
          echo "TCLTK_PREFIX=$TCLTK_PREFIX" >> "$GITHUB_ENV"
          echo "TCL_LIBRARY=$TCLTK_PREFIX/lib/tcl8.6" >> "$GITHUB_ENV"
          echo "TK_LIBRARY=$TCLTK_PREFIX/lib/tk8.6" >> "$GITHUB_ENV"
          echo "DYLD_FALLBACK_LIBRARY_PATH=$TCLTK_PREFIX/lib:/usr/local/lib:/usr/lib" >> "$GITHUB_ENV"

          python -c "import tkinter; print('tkinter OK, TkVersion=', tkinter.TkVersion)"

          # Build .icns from PNG using macOS tools
          ICON_PNG="assets/xtrader_icon.png"
          ICONSET_DIR="$RUNNER_TEMP/xtrader.iconset"
          ICNS_OUT="assets/xtrader.icns"
          rm -rf "$ICONSET_DIR"
          mkdir -p "$ICONSET_DIR"

          for size in 16 32 64 128 256 512; do
            sips -z $size $size "$ICON_PNG" --out "$ICONSET_DIR/icon_${size}x${size}.png" >/dev/null
          done
          # Retina variants
          sips -z 32 32 "$ICON_PNG" --out "$ICONSET_DIR/icon_16x16@2x.png" >/dev/null
          sips -z 64 64 "$ICON_PNG" --out "$ICONSET_DIR/icon_32x32@2x.png" >/dev/null
          sips -z 256 256 "$ICON_PNG" --out "$ICONSET_DIR/icon_128x128@2x.png" >/dev/null
          sips -z 512 512 "$ICON_PNG" --out "$ICONSET_DIR/icon_256x256@2x.png" >/dev/null
          sips -z 1024 1024 "$ICON_PNG" --out "$ICONSET_DIR/icon_512x512@2x.png" >/dev/null

          iconutil -c icns "$ICONSET_DIR" -o "$ICNS_OUT"
          test -f "$ICNS_OUT"

      - name: Install dependencies + Nuitka
        working-directory: X_Trader_AutoBot
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install "nuitka==2.8"

      - name: Set Nuitka cache dir (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $p = Join-Path $env:RUNNER_TEMP "nuitka_cache"
          New-Item -ItemType Directory -Force -Path $p | Out-Null
          "NUITKA_CACHE_DIR=$p" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Set Nuitka cache dir (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -e
          mkdir -p "$RUNNER_TEMP/nuitka_cache"
          echo "NUITKA_CACHE_DIR=$RUNNER_TEMP/nuitka_cache" >> "$GITHUB_ENV"

      - name: Make Windows icon (.ico)
        if: runner.os == 'Windows'
        working-directory: X_Trader_AutoBot
        shell: pwsh
        run: |
          pip install pillow
          python -c "from PIL import Image; img=Image.open('assets/xtrader_icon.png').convert('RGBA'); img.save('assets/xtrader.ico', sizes=[(256,256),(128,128),(64,64),(48,48),(32,32),(16,16)])"

      - name: Build (Windows) - Nuitka app-dist (onedir)
        if: runner.os == 'Windows'
        working-directory: X_Trader_AutoBot
        shell: pwsh
        run: |
          python -m nuitka `
            app.pyw `
            --mode=app-dist `
            --enable-plugin=tk-inter `
            --include-data-dir=assets=assets `
            --assume-yes-for-downloads `
            --output-dir=build `
            --windows-console-mode=disable `
            --windows-icon-from-ico=assets\\xtrader.ico `
            --company-name="X-Trader" `
            --product-name="X-Trader AutoBot" `
            --file-description="X-Trader AutoBot" `
            --file-version="${{ steps.ver.outputs.win }}" `
            --product-version="${{ steps.ver.outputs.win }}"

      - name: Build (Linux) - Nuitka app-dist (onedir)
        if: runner.os == 'Linux'
        working-directory: X_Trader_AutoBot
        shell: bash
        run: |
          set -e
          python -m nuitka \
            app.pyw \
            --mode=app-dist \
            --enable-plugin=tk-inter \
            --include-data-dir=assets=assets \
            --assume-yes-for-downloads \
            --output-dir=build

      - name: Build (macOS) - Nuitka app-dist (.app)
        if: runner.os == 'macOS'
        working-directory: X_Trader_AutoBot
        shell: bash
        run: |
          set -e
          : "${TCLTK_PREFIX:?TCLTK_PREFIX not set}"
          python -m nuitka \
            app.pyw \
            --mode=app-dist \
            --enable-plugin=tk-inter \
            --tcl-library-dir="$TCLTK_PREFIX/lib/tcl8.6" \
            --tk-library-dir="$TCLTK_PREFIX/lib/tk8.6" \
            --include-data-dir=assets=assets \
            --assume-yes-for-downloads \
            --output-dir=build \
            --macos-app-icon=assets/xtrader.icns

      - name: Locate dist/app
        id: out
        shell: bash
        run: |
          set -e
          if [ "$RUNNER_OS" = "macOS" ]; then
            APP="$(find X_Trader_AutoBot -maxdepth 6 -type d -name '*.app' | head -n 1 || true)"
            if [ -z "$APP" ]; then
              echo "No .app found"; exit 1
            fi
            echo "app=$APP" >> $GITHUB_OUTPUT
          else
            DIST="$(find X_Trader_AutoBot -maxdepth 6 -type d -name '*.dist' | head -n 1 || true)"
            if [ -z "$DIST" ]; then
              echo "No .dist found"; exit 1
            fi
            echo "dist=$DIST" >> $GITHUB_OUTPUT
          fi

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          $dist = "${{ steps.out.outputs.dist }}"
          if (-not (Test-Path $dist)) { Write-Error "DIST not found: $dist"; exit 1 }
          Compress-Archive -Path $dist -DestinationPath artifacts\\X-Trader_AutoBot-windows.zip -Force

      - name: Package (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -e
          mkdir -p artifacts
          DIST="${{ steps.out.outputs.dist }}"
          if [ ! -d "$DIST" ]; then
            echo "DIST not found: $DIST"; exit 1
          fi
          (cd "$(dirname "$DIST")" && zip -r "../../artifacts/X-Trader_AutoBot-linux.zip" "$(basename "$DIST")")

      - name: Package (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -e
          mkdir -p artifacts
          APP="${{ steps.out.outputs.app }}"
          if [ ! -d "$APP" ]; then
            echo "APP not found: $APP"; exit 1
          fi
          ditto -c -k --keepParent "$APP" "artifacts/X-Trader_AutoBot-macos.zip"

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ runner.os }}-X-Trader_AutoBot
          path: artifacts/*.zip
          include-hidden-files: true

      - name: Publish GitHub Release (tag only)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.zip

        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.zip
