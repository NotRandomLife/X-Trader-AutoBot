name: Build & Release (Nuitka OneDir)

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          architecture: "x64"
          cache: "pip"
          cache-dependency-path: |
            X_Trader_AutoBot/requirements.txt

      - name: Compute Windows version
        id: ver
        shell: pwsh
        run: |
          $ref = "$env:GITHUB_REF"
          $ver = "0.0.0.0"
          if ($ref -like "refs/tags/v*") {
            $tag = $ref.Replace("refs/tags/","")
            $sem = $tag.Replace("v","")
            $parts = $sem.Split(".")
            $a = if ($parts.Length -ge 1 -and $parts[0]) { $parts[0] } else { "0" }
            $b = if ($parts.Length -ge 2 -and $parts[1]) { $parts[1] } else { "0" }
            $c = if ($parts.Length -ge 3 -and $parts[2]) { $parts[2] } else { "0" }
            $ver = "$a.$b.$c.0"
          }
          "win=$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Install deps + Nuitka
        working-directory: X_Trader_AutoBot
        shell: pwsh
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install "nuitka==2.8"
          pip install pillow

      - name: Set Nuitka cache dir
        shell: pwsh
        run: |
          $p = Join-Path $env:RUNNER_TEMP "nuitka_cache"
          New-Item -ItemType Directory -Force -Path $p | Out-Null
          "NUITKA_CACHE_DIR=$p" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Make icon (.ico)
        working-directory: X_Trader_AutoBot
        shell: pwsh
        run: |
          python -c "from PIL import Image; img=Image.open('assets/xtrader_icon.png').convert('RGBA'); img.save('assets/xtrader.ico', sizes=[(256,256),(128,128),(64,64),(48,48),(32,32),(16,16)])"

      - name: Build (Nuitka OneDir)
        working-directory: X_Trader_AutoBot
        shell: pwsh
        run: |
          python -m nuitka `
            app.pyw `
            --mode=app-dist `
            --enable-plugin=tk-inter `
            --include-data-dir=assets=assets `
            --assume-yes-for-downloads `
            --output-dir=build `
            --windows-console-mode=disable `
            --windows-icon-from-ico=assets\xtrader.ico `
            --company-name="X-Trader" `
            --product-name="X-Trader AutoBot" `
            --file-description="X-Trader AutoBot" `
            --file-version="${{ steps.ver.outputs.win }}" `
            --product-version="${{ steps.ver.outputs.win }}"

      - name: Package zip
        shell: pwsh
        working-directory: X_Trader_AutoBot
        run: |
          $dist = Get-ChildItem -Directory build\*.dist | Select-Object -First 1
          if (-not $dist) { Write-Error "No .dist found"; exit 1 }
          New-Item -ItemType Directory -Force -Path ..\artifacts | Out-Null
          Compress-Archive -Path $dist.FullName -DestinationPath ..\artifacts\X-Trader_AutoBot-windows.zip -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: artifacts/X-Trader_AutoBot-windows.zip

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
          cache-dependency-path: |
            X_Trader_AutoBot/requirements.txt

      - name: System deps (Tk)
        run: |
          sudo apt-get update
          sudo apt-get install -y tk-dev tcl-dev zip

      - name: Install deps + Nuitka
        working-directory: X_Trader_AutoBot
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install "nuitka==2.8"

      - name: Set Nuitka cache dir
        run: |
          mkdir -p "$RUNNER_TEMP/nuitka_cache"
          echo "NUITKA_CACHE_DIR=$RUNNER_TEMP/nuitka_cache" >> "$GITHUB_ENV"

      - name: Build (Nuitka OneDir)
        working-directory: X_Trader_AutoBot
        run: |
          python -m nuitka             app.pyw             --mode=app-dist             --enable-plugin=tk-inter             --include-data-dir=assets=assets             --assume-yes-for-downloads             --output-dir=build

      - name: Package zip
        working-directory: X_Trader_AutoBot
        run: |
          DIST="$(ls -d build/*.dist | head -n 1 || true)"
          if [ -z "$DIST" ]; then echo "No .dist found"; exit 1; fi
          mkdir -p ../artifacts
          (cd build && zip -r "../../artifacts/X-Trader_AutoBot-linux.zip" "$(basename "$DIST")")

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux
          path: artifacts/X-Trader_AutoBot-linux.zip

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.10 (ARM64)
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          architecture: "arm64"
          cache: "pip"
          cache-dependency-path: |
            X_Trader_AutoBot/requirements.txt

      - name: Install Tcl/Tk and prepare icon
        working-directory: X_Trader_AutoBot
        shell: bash
        run: |
          set -e
          brew update
          brew install tcl-tk

          TCLTK_PREFIX="$(brew --prefix tcl-tk)"
          echo "TCLTK_PREFIX=$TCLTK_PREFIX" >> "$GITHUB_ENV"
          echo "TCL_LIBRARY=$TCLTK_PREFIX/lib/tcl8.6" >> "$GITHUB_ENV"
          echo "TK_LIBRARY=$TCLTK_PREFIX/lib/tk8.6" >> "$GITHUB_ENV"
          echo "DYLD_FALLBACK_LIBRARY_PATH=$TCLTK_PREFIX/lib:/usr/local/lib:/usr/lib" >> "$GITHUB_ENV"

          # Sanity: tkinter must import
          python -c "import tkinter; print('tkinter OK, TkVersion=', tkinter.TkVersion)"

          # Build .icns from PNG using macOS tools
          ICON_PNG="assets/xtrader_icon.png"
          ICONSET_DIR="$RUNNER_TEMP/xtrader.iconset"
          ICNS_OUT="assets/xtrader.icns"
          rm -rf "$ICONSET_DIR"
          mkdir -p "$ICONSET_DIR"

          for size in 16 32 64 128 256 512; do
            sips -z $size $size "$ICON_PNG" --out "$ICONSET_DIR/icon_${size}x${size}.png" >/dev/null
          done
          sips -z 32 32 "$ICON_PNG" --out "$ICONSET_DIR/icon_16x16@2x.png" >/dev/null
          sips -z 64 64 "$ICON_PNG" --out "$ICONSET_DIR/icon_32x32@2x.png" >/dev/null
          sips -z 256 256 "$ICON_PNG" --out "$ICONSET_DIR/icon_128x128@2x.png" >/dev/null
          sips -z 512 512 "$ICON_PNG" --out "$ICONSET_DIR/icon_256x256@2x.png" >/dev/null
          sips -z 1024 1024 "$ICON_PNG" --out "$ICONSET_DIR/icon_512x512@2x.png" >/dev/null

          iconutil -c icns "$ICONSET_DIR" -o "$ICNS_OUT"
          test -f "$ICNS_OUT"

      - name: Install deps + Nuitka
        working-directory: X_Trader_AutoBot
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install "nuitka==2.8"

      - name: Set Nuitka cache dir
        shell: bash
        run: |
          set -e
          mkdir -p "$RUNNER_TEMP/nuitka_cache"
          echo "NUITKA_CACHE_DIR=$RUNNER_TEMP/nuitka_cache" >> "$GITHUB_ENV"

      - name: Build (Nuitka OneDir .app)
        working-directory: X_Trader_AutoBot
        shell: bash
        run: |
          set -e
          : "${TCLTK_PREFIX:?TCLTK_PREFIX not set}"
          python -m nuitka             app.pyw             --mode=app-dist             --enable-plugin=tk-inter             --tcl-library-dir="$TCLTK_PREFIX/lib/tcl8.6"             --tk-library-dir="$TCLTK_PREFIX/lib/tk8.6"             --include-data-dir=assets=assets             --assume-yes-for-downloads             --output-dir=build             --macos-app-icon=assets/xtrader.icns

      - name: Package zip
        working-directory: X_Trader_AutoBot
        shell: bash
        run: |
          set -e
          APP="$(ls -d build/*.app | head -n 1 || true)"
          if [ -z "$APP" ]; then echo "No .app found"; exit 1; fi
          mkdir -p ../artifacts
          ditto -c -k --keepParent "$APP" "../artifacts/X-Trader_AutoBot-macos.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: artifacts/X-Trader_AutoBot-macos.zip

  release:
    needs: [ build-windows, build-linux, build-macos ]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release

      - name: Flatten zips
        shell: bash
        run: |
          set -e
          mkdir -p out
          find release -type f -name "*.zip" -maxdepth 3 -print -exec cp -f {} out/ \;
          ls -la out

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: out/*.zip

        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.zip
